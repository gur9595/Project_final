<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
	<mapper namespace="mybatis.ClubDAOImpl">
  	
		<!-- 클럽생성 --> 
		<insert id="clubCreate" parameterType="mybatis.ClubDTO"> 
		  insert into club (c_idx,c_name,c_emb,c_area,c_gender,c_type,c_ability,c_memlimit,c_memo,c_age) values( 
		  	club_seq.nextval, #{c_name}, #{c_emb}, #{c_area},#{c_gender}, #{c_type},
		  	#{c_ability}, #{c_memlimit}, #{c_memo}, #{c_age} ) 
		</insert> 
		
		<!-- 클럽 상세보기 메인 -->
		<select id="clubView" resultType="mybatis.ClubDTO">
			select *
			from club
			where c_idx = #{param1} 
		</select>
		
		<!-- 클럽회원 수 체크 -->
		<select id="clubMemberCount" resultType="int">
			select count(*) from clubmember where c_idx=#{c_idx}
		</select>
		
		<!-- 클럽 상세보기 회원정보 -->
		<select id="clubViewMember" resultType="mybatis.MemberDTO">
		     select m.m_name, m.m_birth, m.m_sex, m.m_position, m.m_foot, m.m_pic, m.m_phone, cm.cm_idx
		     from member m inner join clubmember cm on m.m_id = cm.m_id where cm.c_idx = #{c_idx} order by cm_grade asc
		</select>	
		
		<!-- 클럽 상세보기 모든경기정보 -->
		<select id="clubViewMatch" resultType="mybatis.MatchDTO">
			select g.* 
			from game g inner join club c 
				on g.c_idx = c.c_idx 
			where g.c_idx = #{param1} and g.g_check not like 'no'  order by g.g_date asc
		</select>
		
		<select id="clubMatchOpponent" resultType="mybatis.MatchDTO">
			select * 
			from club
			where c_idx in (select c_idx
			from game
			where g_num = #{param1} and g_check not like 'no' and c_idx != #{param2})
		</select>
		
		<select id="clubMatchOpponentCount" resultType="int">
			select count(*) 
			from club
			where c_idx in (select c_idx
			from game
			where g_num = #{param1} and g_check not like 'no' and c_idx != #{param2})
		</select>
		
		<!-- 클럽 상세보기 접수현황 -->
		<select id="clubViewAccept" resultType="mybatis.GameDTO">
			select g.*, c.c_name from game g inner join club c on g.c_idx = c.c_idx
			where g.g_num in ( select g_num from game where c_idx=#{c_idx} )
			and g.g_check = 'no' order by g.g_date 
		</select>
		
		<!-- 클럽 상세보기 권한관리 -->
		<select id="clubViewGrade" resultType="mybatis.MemberDTO">
			select m.m_id, m.m_name, m.m_birth, m.m_phone, m.m_sex, m.m_addr, cm.cm_grade
			from member m inner join clubmember cm on m.m_id = cm.m_id where cm.c_idx = #{c_idx} 
		</select>
		
		<!-- 권한관리 수정 -->
		<update id="clubViewUpdate" parameterType="mybatis.MemberDTO">
			update clubmember set cm_grade = #{param2} where c_idx = #{param1} and m_id like #{param3}
		</update>
		
	  <select id="getTotalCount" resultType="int" >
		select count(*) from club 
	  </select>
	  
	  <select id="getTotalCountFilter" resultType="int" parameterType="mybatis.ClubDTO">
		select count(*) from club 
			<if test="c_name!='' or c_area!='' or c_ability!='' or c_gender!='' or c_age!=''" >
			where
			<if test="c_name!=''">
				    c_name like #{c_name}
			</if>
			<if test="c_name!='' and ( c_area!='' or c_ability!='' or c_gender!='' or c_age!='' )">
				  and  
			</if>
			<if test="c_area!=''">
				    c_area like #{c_area}
			</if>
			<if test="c_area!='' and ( c_ability!='' or c_gender!='' or c_age!='' )">
				  and  
			</if>
			<if test="c_ability!=''">
				    c_ability like #{c_ability}
			</if>
			<if test="c_ability!='' and (c_gender!='' or c_age!='' )">
				  and  
			</if>
			<if test="c_gender!=''">
				    c_gender like #{c_gender}
			</if>
			<if test="c_gender!='' and c_age!=''">
				  and  
			</if>
			<if test="c_age!=''">
				    c_age like #{c_age}
			</if>
		</if>
	  </select>
	  
	  
	  <select id="listPage" resultType="mybatis.ClubDTO">
		select * from ( 
			select tb.*, rownum rNum from (
				select * from club order by c_idx desc		
			) tb 
		)
		where rNum between #{param1} and #{param2}		
	  </select>
	  
	  <select id="listPageFilter" resultType="mybatis.ClubDTO" parameterType="mybatis.ClubDTO">
	 	select * from ( 
			 select tb.*, rownum rNum from( 
			 	select * from club 
				<if test="c_name!='' or c_area!='' or c_ability!='' or c_gender!='' or c_age!=''" >
					where
					<if test="c_name!=''">
						    c_name like #{c_name}
					</if>
					<if test="c_name!='' and ( c_area!='' or c_ability!='' or c_gender!='' or c_age!='' )">
						  and  
					</if>
					<if test="c_area!=''">
						    c_area like #{c_area}
					</if>
					<if test="c_area!='' and ( c_ability!='' or c_gender!='' or c_age!='' )">
						  and  
					</if>
					<if test="c_ability!=''">
						    c_ability like #{c_ability}
					</if>
					<if test="c_ability!='' and (c_gender!='' or c_age!='' )">
						  and  
					</if>
					<if test="c_gender!=''">
						    c_gender like #{c_gender}
					</if>
					<if test="c_gender!='' and c_age!=''">
						  and  
					</if>
					<if test="c_age!=''">
						    c_age like #{c_age}
					</if>
				</if>
				 	order by c_idx desc		 
			 	) tb 
		 	) 
		 where rNum between #{start} and #{end} 
	  </select>
	  
	<insert id="clubApply" parameterType="mybatis.ClubMemberDTO">
		insert into clubmember values(clubmember_seq.nextval, #{c_idx}, #{m_id}, default, default, default, #{cm_memo})
	</insert>
	
	<insert id="gameMemberApply" parameterType="mybatis.GameMemberDTO">
		insert into gamemember values(gamemember_seq.nextval, #{g_idx}, #{m_id}, default)
	</insert>
	
	<select id="myClubList" resultType="mybatis.ClubDTO">
		select * 
		from club c inner join clubmember cm
			on c.c_idx = cm.c_idx
		where cm.m_id like #{param1} 
	</select>

	<select id="myClubListA" resultType="mybatis.ClubDTO">
		select * 
		from club c inner join clubmember cm
			on c.c_idx = cm.c_idx
		where cm.m_id = #{m_id} 
	</select>
	
	<select id="myClubListCount" resultType="int">
		select count(*) 
		from club c inner join clubmember cm
			on c.c_idx = cm.c_idx
		where cm.m_id like #{param1} 
	</select>
	

	
	<select id="clubIdx" resultType="int" parameterType="mybatis.ClubDTO">
		select c_idx
		from club
		where c_name like #{c_name}
	</select>
	
	<insert id="clubCreateMember"> 
		  insert into clubmember (cm_idx,c_idx,m_id,cm_check,cm_date, cm_grade, cm_memo) values( 
		  	clubmember_seq.nextval, #{param2}, #{param1}, 'yes', default, 'head',
		  	'클럽 생성자' ) 
	  </insert> 
	  
	  <select id="clubManageApplyList" resultType="mybatis.MemberDTO" parameterType="mybatis.ClubDTO">
		select m.*, cm.cm_memo, cm.cm_idx
		from member m inner join clubmember cm
			on m.m_id = cm.m_id
		where cm.c_idx = #{c_idx} and cm.cm_check = 'no'
	</select>
	
	<update id="clubMemberApply">
		update clubmember set cm_check = 'yes' where cm_idx = #{param1}
	</update>
	
	<delete id="clubMemberReject">
		delete from clubmember where cm_idx = #{param1}
	</delete>
	
	<select id="clubMakingForm" resultType="mybatis.GameMemberDTO">
		select *
		from gamemember
		where g_idx like #{param1}
	</select>
	  
  </mapper>